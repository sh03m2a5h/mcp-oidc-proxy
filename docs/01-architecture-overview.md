# MCP OIDC Proxy - Architecture Overview

## 概要

MCP OIDC ProxyのGo実装は、単一の実行可能ファイルとして動作するOIDC認証プロキシです。
既存のNginx/OpenResty実装と同等の機能を提供しながら、より簡単なデプロイメントとメンテナンスを実現します。

## 設計原則

1. **単一バイナリ**: 依存関係を最小限に抑え、単一の実行ファイルとして配布
2. **設定の柔軟性**: 環境変数、設定ファイル、コマンドライン引数をサポート
3. **互換性**: 既存のMCPクライアント/サーバーとの完全な互換性
4. **拡張性**: プラグイン可能なセッション管理とOIDCプロバイダー対応
5. **パフォーマンス**: 高負荷に耐える非同期処理とコネクションプーリング

## アーキテクチャ図

```
┌─────────────────┐     ┌────────────────────────┐     ┌─────────────────┐
│   MCP Client    │────▶│    MCP OIDC Proxy      │────▶│   MCP Server    │
└─────────────────┘     │                        │     └─────────────────┘
                        │  ┌──────────────────┐  │
                        │  │   HTTP Server    │  │
                        │  ├──────────────────┤  │
                        │  │  OIDC Handler    │  │
                        │  ├──────────────────┤  │
                        │  │ Session Manager  │  │
                        │  ├──────────────────┤  │
                        │  │  Reverse Proxy   │  │
                        │  └──────────────────┘  │
                        └────────────────────────┘
                                    │
                                    ▼
                        ┌────────────────────────┐
                        │   OIDC Provider        │
                        │  (Auth0/Google/etc)    │
                        └────────────────────────┘
```

## コンポーネント

### 1. HTTP Server
- **責務**: HTTPリクエストの受信とルーティング
- **機能**:
  - TLS対応
  - WebSocketアップグレード
  - ヘルスチェックエンドポイント
  - メトリクスエンドポイント（Prometheus形式）

### 2. OIDC Handler
- **責務**: OAuth 2.1/OIDC認証フローの処理
- **機能**:
  - 認証リクエストの生成（PKCE対応）
  - コールバック処理
  - トークン検証とリフレッシュ
  - ユーザー情報の取得

### 3. Session Manager
- **責務**: セッション情報の管理
- **実装**:
  - メモリストア（開発/単一インスタンス用）
  - Redisストア（本番/マルチインスタンス用）
- **機能**:
  - セッションの作成/更新/削除
  - セッションタイムアウト管理
  - 同時セッション数制限

### 4. Reverse Proxy
- **責務**: MCPサーバーへのリクエスト転送
- **機能**:
  - HTTPリクエストのプロキシ
  - WebSocketのプロキシ
  - ヘッダーの追加/削除
  - リトライとサーキットブレーカー

## データフロー

### 認証フロー
1. クライアントがプロキシにアクセス
2. セッションチェック → 未認証の場合は3へ
3. OIDCプロバイダーへリダイレクト（state + PKCE）
4. ユーザーが認証
5. コールバックでcode受信
6. codeをトークンに交換
7. ユーザー情報を取得
8. セッション作成
9. 元のリクエストにリダイレクト

### プロキシフロー
1. 認証済みリクエストを受信
2. セッション検証
3. ユーザー情報をヘッダーに追加
4. MCPサーバーへ転送
5. レスポンスをクライアントに返却

## セキュリティ考慮事項

1. **PKCE必須**: 認証フローでは常にPKCEを使用
2. **セッション固定化攻撃対策**: 認証後にセッションIDを再生成
3. **CSRF対策**: stateパラメータの検証
4. **XSS対策**: セッションクッキーにHttpOnly属性
5. **タイミング攻撃対策**: 定数時間での比較

## 非機能要件

### パフォーマンス
- 1000+ 同時接続をサポート
- レイテンシ: < 10ms（プロキシオーバーヘッド）
- メモリ使用量: < 100MB（基本構成）

### 可用性
- グレースフルシャットダウン
- ヘルスチェックエンドポイント
- 設定のホットリロード（SIGHUP）

### 運用性
- 構造化ログ（JSON形式）
- メトリクス（Prometheus形式）
- トレーシング（OpenTelemetry対応）

## 次のステップ

1. [API仕様とConfiguration設計](./02-api-configuration.md)
2. [モジュール構造と依存関係](./03-module-structure.md)
3. [実装ロードマップ](./04-implementation-roadmap.md)
4. [デプロイメント戦略](./05-deployment-strategies.md)
