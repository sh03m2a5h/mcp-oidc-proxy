# 実装ロードマップ

## フェーズ1: 基盤構築（完了）

### 1.1 プロジェクトセットアップ ✅
- [x] リポジトリ作成とディレクトリ構造
- [x] go.mod初期化と基本的な依存関係
- [x] Makefile作成
- [x] CI/CD基本設定（GitHub Actions）

### 1.2 設定管理 ✅
- [x] Config構造体定義
- [x] Viper統合（設定ファイル読み込み）
- [x] 環境変数マッピング
- [x] コマンドライン引数（Cobra）
- [x] 設定検証ロジック

### 1.3 基本的なHTTPサーバー ✅
- [x] Ginフレームワークセットアップ
- [x] 基本的なルーティング
- [x] ヘルスチェックエンドポイント
- [x] グレースフルシャットダウン

### 1.4 ロギング基盤 ✅
- [x] Zap logger統合
- [x] 構造化ログ出力
- [x] ログレベル制御
- [x] リクエストロギングミドルウェア

## フェーズ2: 認証機能実装（完了）

### 2.1 OIDCクライアント実装 ✅
- [x] go-oidcライブラリ統合
- [x] ディスカバリーエンドポイント処理
- [x] PKCEフロー実装
- [x] トークン検証

### 2.2 認証ハンドラー ✅
- [x] ログインハンドラー（リダイレクト）
- [x] コールバックハンドラー
- [x] ログアウトハンドラー
- [x] 認証ミドルウェア

### 2.3 セッション管理（メモリ版） ✅
- [x] セッションマネージャーインターフェース
- [x] メモリストア実装
- [x] セッションCookie処理
- [x] セッションタイムアウト

### 2.4 バイパスモード ✅
- [x] バイパス認証ハンドラー
- [x] モード切り替えロジック

## フェーズ3: プロキシ機能実装（完了）

### 3.1 HTTPリバースプロキシ ✅
- [x] httputil.ReverseProxy統合
- [x] ヘッダー追加/削除
- [x] エラーハンドリング
- [x] タイムアウト処理

### 3.2 WebSocket/SSEプロキシ ✅
- [x] WebSocketアップグレード検出
- [x] SSEストリーミング対応
- [x] 双方向プロキシ実装
- [x] コネクション管理
- [x] エラーハンドリング

### 3.3 高度なプロキシ機能 ✅
- [x] リトライロジック
- [x] サーキットブレーカー
- [x] レスポンス記録機能

## フェーズ4: 本番対応機能（完了）

### 4.1 Redisセッション管理 ✅
- [x] go-redis統合
- [x] Redisセッションストア実装
- [x] セッション同期
- [x] フェイルオーバー処理

### 4.2 メトリクスとモニタリング ✅
- [x] Prometheusメトリクス
- [x] カスタムメトリクス定義
- [x] メトリクスエンドポイント
- [x] ダッシュボード設定例

### 4.3 トレーシング ✅
- [x] OpenTelemetry統合
- [x] トレース収集
- [x] Jaeger/Zipkin対応
- [x] 分散トレーシング

### 4.4 セキュリティ強化 ✅
- [x] TLS/HTTPS対応
- [x] セキュリティヘッダー
- [x] CORS設定
- [x] Rate limiting

## フェーズ5: 高度な機能実装（完了）

### 5.1 カスタムヘッダー注入 ✅
- [x] ヘッダーインジェクションミドルウェア実装
- [x] 静的ヘッダー設定機能
- [x] 動的ヘッダー生成（タイムスタンプ、リクエストID、クライアントIP等）
- [x] ユーザーセッション情報ヘッダー
- [x] IPv6対応のクライアントIP抽出
- [x] 包括的テストカバレッジ（100%）

### 5.2 セッション管理の改善 ✅
- [x] 型安全なコンテキストキー実装
- [x] セッション取得ロジックの統一化
- [x] GinコンテキストからHTTPコンテキストへの変換

### 5.3 コード品質向上 ✅
- [x] コードレビューフィードバック対応
- [x] IPv6アドレス対応強化
- [x] コード重複の削除
- [x] 全テスト通過確認

## フェーズ6: テストとドキュメント（1-2週間）

### 6.1 単体テスト
- [x] 各モジュールのテスト
- [x] モックとスタブ
- [x] テストカバレッジ80%以上

### 6.2 統合テスト
- [ ] E2Eテストシナリオ
- [ ] 実際のOIDCプロバイダーでのテスト
- [ ] 負荷テスト

### 6.3 ドキュメント
- [ ] APIドキュメント（OpenAPI）
- [ ] 運用ガイド
- [ ] トラブルシューティングガイド
- [ ] 移行ガイド（Nginx版から）

## フェーズ7: デプロイメントとリリース（1週間）

### 7.1 パッケージング
- [ ] マルチプラットフォームビルド
- [ ] Dockerイメージ作成
- [ ] Helm Chart作成

### 7.2 リリース自動化
- [ ] GitHub Releases統合
- [ ] 自動ビルドパイプライン
- [ ] バージョニング戦略

### 7.3 運用ツール
- [ ] 設定マイグレーションツール
- [ ] ヘルスチェックスクリプト
- [ ] ログ分析ツール

## マイルストーン

| マイルストーン | 目標期日 | 成果物 | 状況 |
|-------------|---------|--------|------|
| M1: MVP | 3週間 | 基本的な認証とプロキシ機能 | ✅ 完了 |
| M2: Beta | 6週間 | Redis対応、メトリクス | ✅ 完了 |
| M3: Advanced | 8週間 | カスタムヘッダー注入、SSE/WebSocket対応 | ✅ 完了 |
| M4: RC | 10週間 | 全機能実装、テスト完了 | 🔄 進行中 |
| M5: GA | 12週間 | 本番リリース | 📋 予定 |

## セキュリティ方針

**重要**: 本プロキシはCloudflare Tunnelでの運用を前提とし、以下のセキュリティ機能はCloudflareレイヤーで実装します：
- Rate limiting
- DDoS対策
- WAF（Web Application Firewall）
- Bot対策
- IP制限

プロキシ自体は認証とルーティングに集中し、シンプルで高性能な実装を維持します。

## リスクと対策

### 技術的リスク
1. **WebSocketプロキシの複雑性**
   - 対策: 早期プロトタイプとテスト

2. **OIDCプロバイダーの差異**
   - 対策: 主要プロバイダーでの早期テスト

3. **パフォーマンス要件**
   - 対策: 早期の負荷テストとプロファイリング

### スケジュールリスク
1. **依存ライブラリの問題**
   - 対策: 代替ライブラリの調査

2. **テスト環境構築**
   - 対策: Docker Composeでのテスト環境

## 成功指標

- [x] テストカバレッジ > 80% （達成: 各モジュール80%+）
- [x] 既存Nginx実装との機能互換性 （達成: 全機能対応）
- [x] セキュリティヘッダー対応 （達成: 包括的実装）
- [x] カスタムヘッダー注入機能 （達成: 静的/動的/ユーザー）
- [x] ストリーミング対応 （達成: SSE/WebSocket）
- [ ] 1000+ 同時接続のサポート （要検証）
- [ ] レイテンシ < 10ms （要検証）
- [ ] メモリ使用量 < 100MB （要検証）
- [ ] ゼロダウンタイムデプロイ可能 （要検証）

## 次のドキュメント

→ [デプロイメント戦略](./05-deployment-strategies.md)
